<!DOCTYPE html>
<meta charset="utf-8">
<html>
<body>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
  color: white; 
}

</style>
    <script type="text/javascript" src="js/d3.v2.js"></script>
    <script src="js/jquery-1.9.1.js"></script>
    <script src="js/bootstrap.js"></script>
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css">
<script>

/*modified from Mike Bostock at http://bl.ocks.org/3943967 */

var data = [    
    {'unit_id' : 8421, 'D' : 4,'S' : 12,'C': 4,'M' : 10 ,'L': 1,'AW': 1,'P':2,'SE': 3,'IA':2,'PO':1,'T':1,'CI':2,'OTH':2,"NONE":1, 'sum': 46},
    {'unit_id' : 8422, 'D' : 4,'S' : 12,'C': 4,'M' : 10 ,'L': 1,'AW': 1,'P':2,'SE': 3,'IA':0,'PO':0,'T':0,'CI':0,'OTH':0,"NONE":0, 'sum': 37},
    {'unit_id' : 8423, 'D' : 6,'S' : 14,'C': 14,'M' : 14 ,'L': 20,'AW': 4,'P':8,'SE': 14,'IA':0,'PO':0,'T':0,'CI':0,'OTH':0,"NONE":0, 'sum': 94}
    // {'unit_id' : 8424, 'D' : 4,'S' : 12,'C': 4,'M' : 10 ,'L': 1,'AW': 1,'P':2,'SE': 3,'IA':2,'PO':1,'T':1,'CI':2,'OTH':2,"NONE":1, 'sum': 46},
    // {'unit_id' : 8425, 'D' : 4,'S' : 12,'C': 4,'M' : 10 ,'L': 1,'AW': 1,'P':2,'SE': 3,'IA':2,'PO':1,'T':1,'CI':2,'OTH':2,"NONE":1, 'sum': 46}
];

var max = 0; 

for(var i = 0; i < data.length; i++){
    if (data[i].sum > max)
	max = data[i].sum;         
}

var relations = ['D','S','C','M','L','AW','P','SE','IA','PO','T','CI','OTH',"NONE"]

//var relations = ["D","C","AW","P","SE","T","CI","OTH"]; 

var margin = {top: 40, right: 10, bottom: 20, left: 50},
width = 960 - margin.left - margin.right,
height = 120 - margin.top - margin.bottom;

var normalize = true;  

var n = relations.length, // number of layers
m = data.length, // number of samples per layer
stack = d3.layout.stack(),
labels = data.map(function(d) {return d.unit_id;}),

//go through each layer (pop1, pop2 etc, that's the range(n) part)
//then go through each object in data and pull out that objects's population data
//and put it into an array where x is the index and y is the number
layers = stack(d3.range(n).map(function(d) { 
    var a = [];
    for (var i = 0; i < m; ++i) {
        a[i] = {x: i, y: data[i][relations[d]], rel: relations[d]};  
    }
    
    return a;
}));

//the largest single layer
yGroupMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y; }); }),
//the largest stack
yStackMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });


var y = d3.scale.ordinal()
    .domain(d3.range(m))
    .rangeRoundBands([2, height], .08);

var x = d3.scale.linear()
    .domain([0, yStackMax])
    .range([0, width]);



function normalizeX(value, dom){    
    var norm = d3.scale.linear().domain([0,dom]).range([0,width]); 
    return norm(value);
}

// var color = d3.scale.linear()
//     .domain([0, n - 1])
//     .range(["#aad", "#556"]);
var color = d3.scale.category20b();
 
var chart = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
 
var layer = chart.selectAll(".layer")
    .data(layers)
  .enter().append("g")
    .attr("class", "layer")
    .style("fill", function(d, i) { return color(i); });


if(normalize) {
    layer.selectAll("rect")
        .data(function(d) { return d; })
        .enter().append("rect")
        .attr("y", function(d) {return y(d.x); })
        .attr("x", function(d) {return normalizeX(d.y0, data[d.x].sum); })
        .attr("height", y.rangeBand())
        .attr("width", function(d) { return normalizeX(d.y, data[d.x].sum);})
	.attr("data-toggle", "tooltip")
	.attr('class','rectooltip')
	.attr('title', function(d) {return d.rel});

} else {
    layer.selectAll("rect")
	.data(function(d) { return d; })
	.enter().append("rect")
	.attr("y", function(d) { return y(d.x) })
	.attr("x", function(d) { return x(d.y0) })
	.attr("height", y.rangeBand())
	.attr("width", function(d) { return x(d.y); })
	.attr("data-toggle", "tooltip")
	.attr('class','rectooltip')
	.attr('title', function(d) {return d.rel});
}


var yAxis = d3.svg.axis()
    .scale(y)
    .tickSize(1)
    .tickPadding(6)
    .tickValues(labels)
    .orient("left");

 chart.append("g")
    .attr("class", "y axis")
    .call(yAxis);

var sClarity = []; 

for(var i = 0; i < data.length; i++){
    if(normalize){
	sClarity[i] = {x: width, y: y(width * (i+1)), sentClarity : 0.3};      	
    } else {
	sClarity[i] = {x: (data[i].sum / max) * width, y: y(width * (i+1)), sentClarity : 0.3};      	
    }
}

chart.selectAll(".bar")
    .data(sClarity)
    .enter().append("text")
    .attr("class", "bar")
    .attr("x", function(d) {return d.x- 5})
    .attr("y", function(d) {return d.y})
    .attr("dx", -3) // padding-right
    .attr("dy", ".9em") // vertical-align: middle
    .attr("text-anchor", "end") // text-align: right
    .attr("font-size", "11px") // text-align: right
    .attr('fill', 'white')
    .text(function(d) {return d.sentClarity});

</script>

<script type="text/javascript">
    $('.rectooltip').tooltip({'container': 'body', 'placement': 'bottom'});
</script>
</body>
</html>